<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Moura Bateria - Controle de Defeito</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> 
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root {
            --moura-blue: #002776;
            --moura-yellow: #FFD700;
            --text-dark: #333;
            --text-light: #666;
            --bg-light: #f8f9fa;
            --bg-dark: #eef2f5;
            --error-red: #dc3545;
            --success-green: #28a745; 
        }

        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem; 
        }

        /* *** TOAST NOTIFICATION STYLES *** */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: calc(100% - 40px);
            max-width: 350px;
        }
        .toast {
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { background-color: var(--success-green); }
        .toast.error { background-color: var(--error-red); }
        .toast.info { background-color: var(--moura-blue); }
        
        /* *** MODAL STYLES *** */
        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 39, 118, 0.8);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(3px);
        }
        #custom-modal {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            padding: 30px;
            width: 90%;
            max-width: 450px;
            text-align: center;
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }
        #modal-overlay.active #custom-modal {
            transform: scale(1);
            opacity: 1;
        }
        #custom-modal h3 {
            color: var(--error-red); 
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6rem;
            margin-top: 0;
            margin-bottom: 0.5rem;
        }
        #modal-content {
            font-size: 1.1rem;
            color: var(--text-dark);
            margin-bottom: 20px;
        }
        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .modal-actions button {
            width: auto;
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 5px;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
        }
        .btn-cancel {
            background: var(--moura-blue); 
            color: white;
        }
        .btn-cancel:hover {
            background: #001f5c;
        }
        .btn-confirm {
            background: var(--error-red); 
            color: white;
        }
        .btn-confirm:hover {
            background: #c30000;
        }

        /* /* *** WALLET STATUS BUTTON *** (Bloco modificado) */
        #wallet-status-box {
            position: static;
            padding: 0 1rem;
            height: 100%;
            display: flex;
            align-items: center;
            font-size: 0.9rem; /* Levemente maior */
            font-weight: 600;
            cursor: pointer;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.2s ease-in-out, border-color 0.2s;
            user-select: none;
            outline: none;
            text-transform: uppercase;
        }
        /* Estilo para quando a carteira estiver DESCONECTADA (Estado inicial - Mantido igual) */
        #wallet-status-box.disconnected {
            background: var(--moura-yellow);
            color: var(--moura-blue);
            border-left: 1px solid var(--moura-yellow); /* Borda amarela para combinar */
        }
        #wallet-status-box.disconnected:hover {
            background: #ffec80;
            color: #001f5c;
        }

        /* Estilo para quando a carteira estiver CONECTADA (NOVO DESIGN: Verde com texto e ícone branco, ponto verde) */
        #wallet-status-box.connected {
            background: var(--success-green); /* Fundo verde */
            color: white; /* Texto branco */
            border-left: 1px solid var(--success-green); /* Borda verde para combinar */
        }
        #wallet-status-box.connected:hover {
            background: #218838; /* Verde mais escuro no hover */
        }

        /* Dots e Ícones */
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            transition: background 0.3s, box-shadow 0.3s;
        }
        /* Cor do Dot quando conectado (Verde) */
        #wallet-status-box.connected .status-dot {
            background: white; /* Dot branco dentro do botão verde */
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.7);
        }
        /* Cor do Dot quando desconectado (Vermelho - no fundo amarelo) */
        #wallet-status-box.disconnected .status-dot {
            background: var(--error-red);
            box-shadow: 0 0 5px var(--error-red);
        }

        #wallet-text {
            margin-right: 8px;
            color: inherit; 
        }
        #wallet-icon {
            font-size: 1.1rem;
            color: inherit; /* Mantém a cor do botão (branco quando conectado, azul quando desconectado) */
        }
        /* *** FIM WALLET STATUS *** */


        /* *** HEADER & NAVIGATION (AJUSTE FINAL) *** */
        .top-header {
            position: relative;
            background: var(--moura-blue);
            padding: 0; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
            height: 55px; 
        }
        
        .top-header .container {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            padding: 0; 
            max-width: 100%; 
            height: 100%;
        }
        
        .top-header .logo {
            padding-left: 0.2rem; 
            display: flex;
            align-items: center;
            height: 100%;
        }

        .top-header .logo img {
            width: 120px; 
            height: 33px; 
            max-width: none;
        }

        /* Estilos da Navegação */
        .main-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-grow: 1; 
            padding: 0 10px;
            height: 100%;
            margin-left: 30px; 
        }
        .main-nav a {
            color: white;
            text-decoration: none;
            font-size: 1rem; 
            font-weight: 500;
            font-family: 'Montserrat', sans-serif;
            transition: color 0.2s;
            position: relative;
            /* Espaço para a seta */
            padding-right: 15px; 
        }
        
        /* Regra CORRIGIDA para adicionar a seta SE O LINK NÃO FOR BLOG OU O ÚLTIMO */
        .main-nav a:not(:last-child)::after {
            content: '▸'; /* Seta de separação */
            position: absolute;
            right: 0;
            color: #ffc000; /* Cor amarela para a seta */
            font-size: 0.8rem; 
            padding-left: 5px;
        }
        
        /* Regra para REMOVER a seta do link "Blog" */
        .main-nav a[href="#blog"]::after {
            content: ''; 
            padding-right: 0; /* Remove padding extra */
        }

        .main-nav a:hover {
            color: var(--moura-yellow);
        }
        
        /* FIM DA NAVEGAÇÃO */


        .hero-section {
            background: linear-gradient(135deg, var(--moura-blue) 0%, #1a3c7a 100%);
            color: white;
            padding: 5rem 0;
            text-align: center;
            position: relative;
            overflow: hidden;
            margin-bottom: 2rem;
        }
        .hero-section::before { 
            content: '';
            position: absolute;
            bottom: -50px;
            left: 0;
            width: 100%;
            height: 100px;
            background: var(--bg-light);
            transform: skewY(-3deg);
            transform-origin: bottom right;
            z-index: 1;
        }
        .hero-section h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 1rem;
            position: relative;
            z-index: 2;
        }
        .hero-section p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0.9;
            position: relative;
            z-index: 2;
        }

        .btn {
            display: inline-block;
            padding: 0.9rem 2rem;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            position: relative;
            overflow: hidden;
            z-index: 2;
        }
        .btn-primary {
            background: var(--moura-yellow);
            color: var(--moura-blue);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .btn-primary:hover {
            background: #ffec80;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.25);
        }
        .btn-secondary {
            background: none;
            color: var(--moura-yellow);
            border: 2px solid var(--moura-yellow);
            margin-left: 1rem;
        }
        .btn-secondary:hover {
            background: var(--moura-yellow);
            color: var(--moura-blue);
            transform: translateY(-2px);
        }

        .section-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 2rem;
            font-weight: 600;
            color: var(--moura-blue);
            text-align: center;
            margin-bottom: 2.5rem;
            position: relative;
        }
        .section-title::after {
            content: '';
            display: block;
            width: 60px;
            height: 4px;
            background: var(--moura-yellow);
            margin: 10px auto 0;
            border-radius: 2px;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            border-top: 6px solid var(--moura-blue);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.12);
        }
        .card h2 {
            font-family: 'Montserrat', sans-serif;
            margin-top: 0;
            font-size: 1.5rem;
            color: var(--moura-blue);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }
        .card h2 i {
            margin-right: 0.8rem;
            color: var(--moura-yellow);
            font-size: 1.8rem;
        }
        .card input, 
        .card button,
        .card select {
            padding: 0.9rem 1.2rem;
            margin-top: 0.2rem; /* Reduced margin-top to accommodate labels */
            border-radius: 5px;
            border: 1px solid #d1d5db;
            width: 100%;
            font-size: 1rem;
            font-weight: 400;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
            color: var(--text-dark);
        }

        .card select {
            appearance: none; 
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23002776%22%20d%3D%22M287%20198.8L154.1%2066.8c-4.7-4.7-12.4-4.7-17.1%200L5.4%20198.8c-4.7%204.7-4.7%2012.4%200%2017.1l17.1%2017.1c4.7%204.7%2012.4%204.7%2017.1%200L145%20108.9c4.7-4.7%2012.4-4.7%2017.1%200L253.3%20233c4.7%204.7%2012.4%204.7%2017.1%200l17.1-17.1c4.7-4.7%204.7-12.4%200-17.1z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 10px;
        }
        
        .card input[type="date"] {
            appearance: none; 
            -moz-appearance: none; 
            -webkit-appearance: none; 
            position: relative; 
            padding-right: 1.2rem; 
            background-color: white; 
            color: var(--text-dark); 
            border: 1px solid #d1d5db; 
        }

        .card label {
            display: block; 
            margin-top: 0.8rem;
            margin-bottom: 0.2rem;
            font-size: 0.9rem; 
            font-weight: 500; 
            color: var(--text-dark);
        }
        .card h2 + label {
            margin-top: 0;
        }

        .card input[type="date"]::placeholder {
            color: #999; 
            opacity: 1; 
        }

        .card input:focus, 
        .card select:focus {
            border-color: var(--moura-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 39, 118, 0.2);
        }
        .card button {
            margin-top: 1.5rem;
            padding: 1rem 1.2rem;
            transition: background-color 0.2s, transform 0.2s;
        }

        ul {
            list-style: none;
            padding: 0;
            margin-top: 1.5rem;
            display: none; 
        }
        li {
            background: var(--bg-dark);
            margin-bottom: 0.8rem;
            padding: 1rem 1.2rem;
            border-left: 5px solid var(--moura-yellow);
            border-radius: 5px;
            font-weight: 500;
            font-size: 0.95rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            color: var(--text-dark);
            transition: opacity 0.3s ease, transform 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        li .data-content {
            flex-grow: 1;
        }
        li strong {
            color: var(--moura-blue);
        }
        li span {
            display: block; 
            margin-bottom: 0.3rem;
        }
        .edit-icon {
            color: var(--moura-blue);
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.2s;
            margin-left: 1rem;
        }
        .edit-icon:hover {
            color: var(--moura-yellow);
        }
        
        /* ESTILO PARA MENSAGEM DE ERRO (Reutilizado para validação) */
        .error-message {
            display: block;
            color: var(--error-red);
            font-size: 0.75rem;
            margin-top: 0.4rem;
            margin-bottom: 0.4rem;
            font-weight: 500;
            min-height: 1em; /* Garante que o layout não pule quando a msg aparece */
        }
        /* Esconde mensagens de erro do formulário por padrão */
        #cardCadastrar .error-message {
            display: none;
        }

        footer {
            background: var(--moura-blue);
            color: white;
            text-align: center;
            padding: 2rem 0;
            margin-top: 3rem;
            font-size: 0.9rem;
        }
        footer a {
            color: var(--moura-yellow);
            text-decoration: none;
            transition: color 0.3s ease;
        }
        footer a:hover {
            color: white;
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>
    
    <div id="modal-overlay">
        <div id="custom-modal">
            <h3 id="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirmar Exclusão</h3>
            <p id="modal-content">Atenção! Este processo irá remover o registro de índice <strong id="modal-index-display">#X</strong> da Blockchain.<br>Por ser uma exclusão <strong>permanente</strong>, confirme os dados antes de prosseguir.</p>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="hideModal()">Cancelar</button>
                <button class="btn btn-confirm" id="confirmRemovalBtn">Confirmar Remoção</button>
            </div>
        </div>
    </div>
    
    <div class="top-header">
        <div class="container">
            
            <div class="logo">
                <a href="https://www.moura.com.br/" target="_blank">
                    <img src="logo-moura.svg" alt="Logo Baterias Moura" /> 
                </a>
            </div>
            
            <nav class="main-nav">
                <a href="#">A Moura</a>
                <a href="#">Produtos</a>
                <a href="#">Serviços</a>
                <a href="#">Moura + Perto de Você</a>
                <a href="#blog">Blog</a> <a href="#">Carreiras</a>
            </nav>
            
            <div id="wallet-status-box" role="button" tabindex="0" aria-label="Conectar Carteira MetaMask" class="disconnected">
                <span class="status-dot" id="wallet-dot"></span>
                <span id="wallet-text">Conectar Carteira</span>
                <i class="fas fa-wallet" id="wallet-icon" style="margin-left: 5px;"></i>
            </div>
            
        </div>
    </div>

    <section class="hero-section">
        <div class="container">
            <h1>O Controle de Baterias Defeituosas na Era Digital.</h1>
            <p>Gerencie o ciclo de vida das suas baterias com transparência e segurança através da tecnologia blockchain.</p>
            <button class="btn btn-primary" id="scrollCadastrar">Comece a Cadastrar Agora!</button>
            <button class="btn btn-secondary" id="scrollListar">Ver Baterias Registradas</button>
        </div>
    </section>
    
    <div class="container">
        <h2 class="section-title">Nossas Ferramentas</h2>

        <div class="cards-grid">
            
            <div class="card" id="cardCadastrar">
                <h2><i class="fas fa-plus-circle"></i> Cadastrar Nova Bateria</h2>
                <input type="hidden" id="editIndex" value="-1" />
                
                <label for="tipo">Tipo de Bateria</label>
                <select id="tipo" required>
                    <option value="" disabled selected>-- Selecione um Tipo --</option>
                    <option value="Automotiva">Carro (Automotiva)</option>
                    <option value="Caminhao">Ônibus e Caminhão</option>
                    <option value="Moto">Moto</option>
                    <option value="Nautica">Náutica</option>
                    <option value="Estacionaria">Estacionária</option>
                    <option value="Tracionaria">Tracionária</option>
                    <option value="Metroferroviaria">Metroferroviária</option>
                    <option value="BESS">BESS</option>
                </select>
                <span class="error-message" id="tipoError"></span>

                <label for="uso">Uso Reportado</label>
                <input type="text" id="uso" placeholder="Ex: Curto-circuito, Falha na Partida" />
                <span class="error-message" id="usoError"></span>
                
                <label for="nr_serie">Número de Série</label>
                <input type="text" id="nr_serie" placeholder="Número de Série da Bateria" />
                <span class="error-message" id="nr_serieError"></span>
                
                <label for="dataprod">Data de Fabricação</label>
                <input type="date" id="dataprod" placeholder="Data de Fabricação (AAAA-MM-DD)" required />
                <span class="error-message" id="dataprodError"></span>
                
                <label for="lote">Lote de Fabricação</label>
                <input type="text" id="lote" placeholder="Lote de Fabricação" />
                <span class="error-message" id="loteError"></span>
                
                <button class="btn btn-primary" id="cadastrarBtn"><i class="fas fa-save"></i> Registrar Defeito</button>
            </div>

            
            <div class="card" id="cardListar">
                <h2><i class="fas fa-list-alt"></i> Listar Baterias Registradas</h2>
                <p>Acesse a lista completa de todas as baterias marcadas como defeituosas na rede.</p>
                <button class="btn btn-primary" id="listarBtn"><i class="fas fa-eye"></i> Mostrar Registros</button>
                <ul id="listaBaterias"></ul>
            </div>

            
            <div class="card" id="cardRemover">
                <h2><i class="fas fa-trash-alt"></i> Remover Registro</h2>
                <p>Remova um registro específico da lista utilizando seu índice único.</p>
                <input type="number" id="indexRemover" placeholder="Índice da bateria" />
                <span id="removeErrorMsg" class="error-message" style="display: none;"></span> 
                <button class="btn btn-primary" id="removerBtn"><i class="fas fa-minus-circle"></i> Remover Registro</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2025 Moura Bateria. Todos os direitos reservados. | Desenvolvido com <a href="https://www.ethers.org/" target="_blank">Ethers.js</a> e Blockchain.</p>
        </div>
    </footer>

    <script>
        const CONTRACT_ADDRESS = "0xeBbc46B6Ee9DBBe0A31bB5a22149738d5908f70e"; 
        
        const ABI = [
            { "inputs": [], "stateMutability": "nonpayable", "type": "constructor" },
            { "inputs": [ { "internalType": "string", "name": "_tipo", "type": "string" }, { "internalType": "string", name: "_uso", "type": "string" }, { "internalType": "string", name: "_nr_serie", "type": "string" }, { "internalType": "string", name: "_dataprod", "type": "string" }, { "internalType": "string", "name": "_lote", "type": "string" } ], "name": "cadastrarDefeituosa", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [ { "internalType": "uint256", name: "index", "type": "uint256" }, { "internalType": "string", name: "_tipo", "type": "string" }, { "internalType": "string", name: "_uso", "type": "string" }, { "internalType": "string", name: "_nr_serie", "type": "string" }, { "internalType": "string", name: "_dataprod", "type": "string" }, { "internalType": "string", "name": "_lote", "type": "string" } ], "name": "atualizarDefeituosa", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [], "name": "getBaterias", "outputs": [ { "internalType": "uint256", name: "", "type": "uint256" } ], "stateMutability": "view", "type": "function" },
            { "inputs": [], "name": "listarBaterias", "outputs": [ { "components": [ { "internalType": "string", name: "tipo", "type": "string" }, { "internalType": "string", name: "uso", "type": "string" }, { "internalType": "string", name: "nr_serie", "type": "string" }, { "internalType": "string", name: "_dataprod", "type": "string" }, { "internalType": "string", name: "lote", "type": "string" } ], "internalType": "struct MouraBateria.Bateria[]", name: "", "type": "tuple[]" } ], "stateMutability": "view", "type": "function" },
            { "inputs": [ { "internalType": "uint256", name: "index", "type": "uint256" } ], "name": "removerBaterias", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
        ];

        let provider, signer, contract;
        let currentAccount = null; 
        let listaAtual = [];
        const removeErrorMsg = document.getElementById("removeErrorMsg");
        const modalOverlay = document.getElementById("modal-overlay");
        const modalIndexDisplay = document.getElementById("modal-index-display");
        
        const walletStatusBox = document.getElementById("wallet-status-box");
        const walletDot = document.getElementById("wallet-dot");
        const walletText = document.getElementById("wallet-text");

        // =========================================================================
        // TOAST NOTIFICATION FUNCTION
        // =========================================================================
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 4000);
        }

        // =========================================================================
        // WALLET STATUS & CONNECTION/DISCONNECTION LOGIC
        // =========================================================================
        const updateWalletStatus = (isConnected, account = null) => {
            if (isConnected && account) {
                currentAccount = account;
                walletStatusBox.classList.remove('disconnected');
                walletStatusBox.classList.add('connected');
                const shortAddress = `${account.substring(0, 6)}...${account.substring(account.length - 4)}`;
                walletText.textContent = shortAddress;
                walletStatusBox.setAttribute('aria-label', 'Desconectar Carteira MetaMask');
            } else {
                currentAccount = null;
                walletStatusBox.classList.remove('connected');
                walletStatusBox.classList.add('disconnected');
                walletText.textContent = "Conectar Carteira";
                walletStatusBox.setAttribute('aria-label', 'Conectar Carteira MetaMask');
            }
        };
        
        const connectWallet = async () => {
            if (!window.ethereum) {
                console.error("MetaMask não encontrado.");
                showToast("Por favor, instale o MetaMask para continuar.", "error");
                updateWalletStatus(false);
                return;
            }
            try {
                const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
                const account = accounts[0];

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                
                updateWalletStatus(true, account);
                await carregarDadosSilenciosamente(); 
                
                window.ethereum.on('accountsChanged', handleAccountsChanged);

            } catch (error) {
                console.error("Erro ao conectar:", error);
                updateWalletStatus(false);
            }
        };
        
        const disconnectWallet = async () => {
            if (!window.ethereum || !currentAccount) {
                console.log("Já desconectado ou MetaMask não disponível.");
                return;
            }
            try {
                await window.ethereum.request({
                    method: "wallet_revokePermissions",
                    params: [{ eth_accounts: {} }]
                });
                handleAccountsChanged([]); 
                showToast("Desconectado com sucesso!", "success");
            } catch (error) {
                if (error.code === 4001) {
                     console.log("Desconexão rejeitada pelo usuário.");
                } else {
                     console.error("Erro ao desconectar:", error);
                }
            }
        };

        const handleAccountsChanged = (accounts) => {
            if (accounts.length === 0) {
                console.log("Carteira desconectada.");
                updateWalletStatus(false);
                provider = null; signer = null; contract = null; currentAccount = null;
            } else {
                connectWallet(); 
            }
        };

        walletStatusBox.addEventListener('click', () => {
            if (currentAccount) {
                disconnectWallet();
            } else {
                connectWallet();
            }
        });

        window.addEventListener("load", async () => {
         if (window.ethereum) {
             const accounts = await window.ethereum.request({ method: "eth_accounts" });
             if (accounts.length > 0) {
                 await connectWallet();
             } else {
                 updateWalletStatus(false);
                 provider = new ethers.providers.Web3Provider(window.ethereum);
                 contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider); 
                 await carregarDadosSilenciosamente(); 
             }
             window.ethereum.on('accountsChanged', handleAccountsChanged);
         } else {
             updateWalletStatus(false);
         }
        });

        // =========================================================================
        // RESTANTE DO CÓDIGO (FUNÇÕES DE CONTRATO)
        // =========================================================================

        const inputTipo = document.getElementById("tipo");
        const inputUso = document.getElementById("uso");
        const inputNrSerie = document.getElementById("nr_serie");
        const inputDataProd = document.getElementById("dataprod");
        const inputLote = document.getElementById("lote");
        const inputEditIndex = document.getElementById("editIndex");
        const btnCadastrar = document.getElementById("cadastrarBtn");
        const inputRemover = document.getElementById("indexRemover");

        const showModal = (index) => {
            modalIndexDisplay.textContent = `#${index}`;
            modalOverlay.style.display = 'flex';
            modalOverlay.classList.add('active');
            document.getElementById("confirmRemovalBtn").onclick = () => confirmRemoval(index);
        };

        const hideModal = () => {
            modalOverlay.style.display = 'none';
            modalOverlay.classList.remove('active');
            document.getElementById("confirmRemovalBtn").onclick = null;
        };
        
        const confirmRemoval = async (index) => {
            hideModal(); 
            if(!contract || !currentAccount) {
                showToast("Carteira não conectada. Conecte-se para remover.", "error");
                document.getElementById("removerBtn").disabled = false;
                return;
            }

            const originalButtonText = document.getElementById("removerBtn").innerHTML;
            document.getElementById("removerBtn").innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removendo...';
            document.getElementById("removerBtn").disabled = true;
            const listItemToRemove = document.getElementById(`bateria-${index}`);

            try {
                const tx = await contract.removerBaterias(index);
                await tx.wait();
                
                if (listItemToRemove) {
                    listItemToRemove.style.opacity = '0';
                    listItemToRemove.style.transform = 'translateY(-20px)';
                    setTimeout(() => { listItemToRemove.remove(); }, 300); 
                }
                showToast(`Registro #${index} removido com sucesso.`, 'success');
                document.getElementById("removerBtn").innerHTML = 'Sincronizando...';
                await new Promise(resolve => setTimeout(resolve, 1500)); 
                await listarBateriasNaTela(); 
                
            } catch(err) {
                console.error("Erro ao remover:", err);
                const reason = err.reason || (err.data && err.data.message) || "Transação falhou.";
                displayRemoveError(`Erro na Blockchain: ${reason}`);
            } finally {
                document.getElementById("removerBtn").innerHTML = originalButtonText;
                document.getElementById("removerBtn").disabled = false;
            }
        };

        async function carregarDadosSilenciosamente() {
            if(!contract) return;
            try {
                listaAtual = await contract.listarBaterias();
            } catch (err) {
                console.error("Erro ao carregar dados silenciosamente:", err);
            }
        }

        window.carregarParaEdicao = (index) => {
            if (!currentAccount) {
                showToast("Conecte sua carteira para editar registros.", "error");
                return;
            }

            const bateria = listaAtual[index];
            if (!bateria) {
                console.error("Erro: Bateria não encontrada no índice " + index);
                return;
            }

            inputTipo.value = bateria.tipo;
            inputUso.value = bateria.uso;
            inputNrSerie.value = bateria.nr_serie;
            inputDataProd.value = bateria._dataprod; 
            inputLote.value = bateria.lote;
            inputEditIndex.value = index; 

            btnCadastrar.innerHTML = '<i class="fas fa-edit"></i> Atualizar Bateria #' + index;
            btnCadastrar.style.background = '#0056b3';
            btnCadastrar.style.color = 'white';

            document.getElementById("cardCadastrar").scrollIntoView({ behavior: "smooth", block: "start" });
        };

        const resetFormulario = () => {
            inputEditIndex.value = "-1";
            btnCadastrar.innerHTML = '<i class="fas fa-save"></i> Registrar Defeito';
            btnCadastrar.style.background = 'var(--moura-yellow)';
            btnCadastrar.style.color = 'var(--moura-blue)';
            inputTipo.value = ''; inputUso.value = ''; inputNrSerie.value = '';
            inputDataProd.value = ''; inputLote.value = '';
        };

        const displayRemoveError = (message) => {
            removeErrorMsg.textContent = message;
            removeErrorMsg.style.display = 'block';
        };

        const clearRemoveError = () => {
            removeErrorMsg.style.display = 'none';
            removeErrorMsg.textContent = '';
        };

        async function listarBateriasNaTela() {
            if(!contract) {
                if (window.ethereum) {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider); 
                } else {
                     showToast("Não foi possível conectar ao Metamask/Ethers.", "error");
                     return;
                }
            }
            
            const ul = document.getElementById("listaBaterias");
            const listarBtn = document.getElementById("listarBtn");
            listarBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando...';
            listarBtn.disabled = true;

            try {
                listaAtual = await contract.listarBaterias();
                ul.innerHTML = ""; 
                
                if (listaAtual.length === 0) {
                    ul.innerHTML = '<li>Nenhuma bateria defeituosa registrada ainda.</li>';
                } else {
                    listaAtual.forEach((b, i) => {
                    const li = document.createElement("li");
                    li.id = `bateria-${i}`; 
                    const editIconHTML = currentAccount ? `<i class="fas fa-edit edit-icon" onclick="carregarParaEdicao(${i})"></i>` : '';
                    li.innerHTML = `
                        <div class="data-content">
                            <span><strong>Índice:</strong> #${i}</span>
                            <span><strong>Tipo:</strong> ${b.tipo}</span>
                            <span><strong>Uso:</strong> ${b.uso}</span>
                            <span><strong>Série:</strong> ${b.nr_serie}</span>
                            <span><strong>Data Prod.:</strong> ${b._dataprod}</span>
                            <span><strong>Lote:</strong> ${b.lote}</span>
                        </div>
                        ${editIconHTML}
                    `;
                    ul.appendChild(li);
                    });
                }
                ul.style.display = 'block'; 

            } catch (err) {
                console.error("Erro ao listar:", err);
                ul.innerHTML = '<li>Erro ao carregar os dados. Verifique a rede.</li>';
                ul.style.display = 'block';
            } finally {
                listarBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Ocultar Registros';
                listarBtn.disabled = false;
            }
        }

        document.getElementById("scrollCadastrar").onclick = () => {
            document.getElementById("cardCadastrar").scrollIntoView({ behavior: "smooth", block: "start" });
        };
        document.getElementById("scrollListar").onclick = () => {
            document.getElementById("cardListar").scrollIntoView({ behavior: "smooth", block: "center" });
        };

        document.getElementById("cadastrarBtn").onclick = async () => {
            if(!contract || !currentAccount) {
                showToast("Conecte sua carteira para registrar ou atualizar.", "error");
                return;
            }
            
            // --- NOVA VALIDAÇÃO DETALHADA ---
            const fieldsToValidate = ['tipo', 'uso', 'nr_serie', 'dataprod', 'lote'];
            let isFormValid = true;

            fieldsToValidate.forEach(id => {
                const input = document.getElementById(id);
                const errorSpan = document.getElementById(`${id}Error`);
                if (!input.value) {
                    errorSpan.textContent = 'Este campo é obrigatório.';
                    errorSpan.style.display = 'block';
                    isFormValid = false;
                } else {
                    errorSpan.style.display = 'none';
                }
            });

            if (!isFormValid) {
                showToast("Por favor, preencha todos os campos obrigatórios.", "error");
                return;
            }
            // --- FIM DA VALIDAÇÃO ---

            const tipo = inputTipo.value;
            const uso = inputUso.value;
            const nr = inputNrSerie.value;
            const data = inputDataProd.value;
            const lote = inputLote.value;
            const index = parseInt(inputEditIndex.value);
            
            const originalButtonText = btnCadastrar.innerHTML;
            btnCadastrar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
            btnCadastrar.disabled = true;

            try {
                let tx;
                if (index > -1) {
                    tx = await contract.atualizarDefeituosa(index, tipo, uso, nr, data, lote);
                } else {
                    tx = await contract.cadastrarDefeituosa(tipo, uso, nr, data, lote);
                }
                await tx.wait();
                
                resetFormulario();
                await listarBateriasNaTela();
                const successMsg = `Bateria #${index > -1 ? index : 'nova'} ${index > -1 ? 'atualizada' : 'registrada'} com sucesso!`;
                showToast(successMsg, "success");

            } catch (err) {
                console.error("Erro na transação:", err);
                showToast("Erro na transação: " + (err.reason || "Verifique o console."), "error");
            } finally {
                btnCadastrar.innerHTML = originalButtonText;
                btnCadastrar.disabled = false;
            }
        };

        document.getElementById("listarBtn").onclick = async () => {
            const ul = document.getElementById("listaBaterias");
            const btn = document.getElementById("listarBtn");

            if (ul.style.display === 'block') {
                ul.style.display = 'none';
                btn.innerHTML = '<i class="fas fa-eye"></i> Mostrar Registros';
            } else {
                await listarBateriasNaTela();
            }
        };

        document.getElementById("removerBtn").onclick = async () => {
            clearRemoveError();
            if (!currentAccount) {
                displayRemoveError("Você precisa estar conectado para remover registros.");
                return;
            }

            const index = parseInt(document.getElementById("indexRemover").value);
            
            if(isNaN(index) || index < 0) {
                displayRemoveError("Índice inválido. Insira um número não negativo.");
                return;
            }
            if (index >= listaAtual.length || listaAtual.length === 0) {
                displayRemoveError(`Índice inválido! Último índice é #${listaAtual.length > 0 ? listaAtual.length - 1 : 'nenhum'}.`);
                return;
            }
            showModal(index);
        };
    </script>
</body>
</html>